"""Integrate with searchsploit (Exploit-DB) to lookup exploits from nmap XML."""
import shutil
import subprocess
import re
from pathlib import Path
from typing import List


def strip_ansi_codes(text: str) -> str:
    """Remove ANSI color codes from text."""
    ansi_escape = re.compile(r'\x1B(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~])')
    return ansi_escape.sub('', text)


def has_searchsploit() -> bool:
    return shutil.which("searchsploit") is not None


def searchsploit_from_nmap(xml_path: str) -> List[str]:
    """Run `searchsploit --nmap <xml>` and return lines of output.

    Raises RuntimeError if searchsploit not available or command fails.
    """
    if not has_searchsploit():
        raise RuntimeError("searchsploit not found")

    # Note: macOS searchsploit doesn't accept --colour flag
    cmd = ["searchsploit", "--nmap", xml_path]
    proc = subprocess.run(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
    if proc.returncode != 0:
        raise RuntimeError(f"searchsploit failed: {proc.stderr.strip()}")

    # Strip ANSI color codes and filter empty lines
    lines = [strip_ansi_codes(l) for l in proc.stdout.splitlines() if l.strip()]
    return lines
